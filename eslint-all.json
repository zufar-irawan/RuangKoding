[{"filePath":"D:\\Zufar\\Documents\\Projects\\RuangKoding\\components\\Feedback\\feedback-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Zufar\\Documents\\Projects\\RuangKoding\\components\\Feedback\\request-vote.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'currentUserId' is assigned a value but never used.","line":49,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":49,"endColumn":23}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadInitialData'. Either include it or remove the dependency array.","line":60,"column":6,"nodeType":"ArrayExpression","endLine":60,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [loadInitialData, requestId]","fix":{"range":[1839,1850],"text":"[loadInitialData, requestId]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Skeleton } from \"@/components/ui/skeleton\";\r\nimport {\r\n  Share,\r\n  Link2,\r\n  ChevronUp,\r\n  ChevronDown,\r\n  Bookmark,\r\n  Loader2,\r\n} from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport {\r\n  checkUserRequestVote,\r\n  handleRequestVote,\r\n  checkRequestBookmarkStatus,\r\n  toggleRequestBookmark,\r\n} from \"@/lib/servers/FeedbackAction\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { ShareModal } from \"./ShareModal\";\r\nimport { getClientUser } from \"@/utils/GetClientUser\";\r\n\r\ntype Props = {\r\n  requestId: number;\r\n  initialVoteCount: number;\r\n  requestTitle?: string;\r\n  requestSlug?: string;\r\n  requestUserId: string;\r\n};\r\n\r\nexport default function RequestVote({\r\n  requestId,\r\n  initialVoteCount,\r\n  requestTitle,\r\n  requestSlug,\r\n  requestUserId,\r\n}: Props) {\r\n  const router = useRouter();\r\n  const [isSaved, setIsSaved] = useState(false);\r\n  const [isInitialLoading, setIsInitialLoading] = useState(true);\r\n  const [isVoteLoading, setIsVoteLoading] = useState(false);\r\n  const [isSaveLoading, setIsSaveLoading] = useState(false);\r\n  const [isCopyLoading, setIsCopyLoading] = useState(false);\r\n  const [userVote, setUserVote] = useState<boolean | null>(null);\r\n  const [currentVoteCount, setCurrentVoteCount] = useState(initialVoteCount);\r\n  const [isShareModalOpen, setIsShareModalOpen] = useState(false);\r\n  const [currentUserId, setCurrentUserId] = useState<string | null>(null);\r\n  const [isAuthor, setIsAuthor] = useState(false);\r\n\r\n  const shareUrl =\r\n    typeof window !== \"undefined\"\r\n      ? `${window.location.origin}/lautan-feedback/${requestSlug}-${requestId}`\r\n      : \"\";\r\n\r\n  useEffect(() => {\r\n    loadInitialData();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [requestId]);\r\n\r\n  const loadInitialData = async () => {\r\n    setIsInitialLoading(true);\r\n    try {\r\n      // Get current user\r\n      const user = await getClientUser();\r\n      const userId = user?.id || null;\r\n      setCurrentUserId(userId);\r\n\r\n      // Check if current user is the author\r\n      const userIsAuthor = userId !== null && userId === requestUserId;\r\n      setIsAuthor(userIsAuthor);\r\n\r\n      // Load save status and user vote in parallel\r\n      const [saveStatus, voteStatus] = await Promise.all([\r\n        checkRequestBookmarkStatus(requestId),\r\n        checkUserRequestVote(requestId),\r\n      ]);\r\n\r\n      setIsSaved(saveStatus);\r\n      setUserVote(voteStatus);\r\n    } catch (error) {\r\n      console.error(\"Error loading initial data:\", error);\r\n    } finally {\r\n      setIsInitialLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSave = async () => {\r\n    if (isSaveLoading || isVoteLoading) return;\r\n\r\n    setIsSaveLoading(true);\r\n\r\n    try {\r\n      const result = await toggleRequestBookmark(requestId, isSaved);\r\n\r\n      if (result.success) {\r\n        setIsSaved(result.isSaved);\r\n        toast.success(result.message, {\r\n          duration: 3000,\r\n        });\r\n      } else {\r\n        toast.error(result.message);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error handling save:\", error);\r\n      toast.error(\r\n        error instanceof Error\r\n          ? error.message\r\n          : \"Terjadi kesalahan, silakan coba lagi\",\r\n      );\r\n    } finally {\r\n      setIsSaveLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleVote = async (voteType: boolean) => {\r\n    if (isVoteLoading || isSaveLoading) return;\r\n\r\n    // Prevent author from voting on their own request\r\n    if (isAuthor) {\r\n      toast.error(\"Anda tidak dapat memvote request feedback Anda sendiri\", {\r\n        duration: 3000,\r\n      });\r\n      return;\r\n    }\r\n\r\n    setIsVoteLoading(true);\r\n\r\n    try {\r\n      const result = await handleRequestVote(requestId, voteType);\r\n\r\n      if (result.success) {\r\n        const previousVote = userVote;\r\n        const newVote = result.newVoteState;\r\n\r\n        // Calculate vote count change\r\n        let change = 0;\r\n        if (previousVote === null && newVote !== null) {\r\n          // New vote\r\n          change = newVote ? 1 : -1;\r\n        } else if (previousVote !== null && newVote === null) {\r\n          // Removed vote\r\n          change = previousVote ? -1 : 1;\r\n        } else if (previousVote !== null && newVote !== null) {\r\n          // Changed vote\r\n          change = newVote ? 2 : -2;\r\n        }\r\n\r\n        setUserVote(newVote);\r\n        setCurrentVoteCount((prev) => prev + change);\r\n\r\n        toast.success(\r\n          newVote === null\r\n            ? \"Vote berhasil dihapus\"\r\n            : newVote\r\n              ? \"Berhasil upvote\"\r\n              : \"Berhasil downvote\",\r\n          {\r\n            duration: 2000,\r\n          },\r\n        );\r\n\r\n        router.refresh();\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error handling vote:\", error);\r\n      toast.error(\r\n        error instanceof Error\r\n          ? error.message\r\n          : \"Terjadi kesalahan, silakan coba lagi\",\r\n      );\r\n    } finally {\r\n      setIsVoteLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleCopyLink = async () => {\r\n    if (isCopyLoading) return;\r\n\r\n    setIsCopyLoading(true);\r\n\r\n    try {\r\n      await navigator.clipboard.writeText(shareUrl);\r\n      toast.success(\"Link request telah disalin ke clipboard!\", {\r\n        duration: 2000,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Error copying link:\", error);\r\n      toast.error(\"Gagal menyalin link\");\r\n    } finally {\r\n      setTimeout(() => {\r\n        setIsCopyLoading(false);\r\n      }, 500);\r\n    }\r\n  };\r\n\r\n  // Loading skeleton for initial load\r\n  if (isInitialLoading) {\r\n    return (\r\n      <div className=\"flex flex-wrap items-center justify-between gap-6 w-full rounded-2xl border border-foreground/10 bg-foreground/[0.03] px-8 py-6 shadow-sm\">\r\n        <div className=\"flex flex-col gap-3 max-w-xl flex-1\">\r\n          <Skeleton className=\"h-8 w-3/4\" />\r\n          <Skeleton className=\"h-4 w-full\" />\r\n          <div className=\"flex items-center gap-4 mt-2\">\r\n            <Skeleton className=\"h-11 w-32\" />\r\n            <Skeleton className=\"h-11 w-11 rounded-lg\" />\r\n            <Skeleton className=\"h-11 w-11 rounded-lg\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex flex-col gap-3 items-center justify-center min-w-[220px]\">\r\n          <Skeleton className=\"h-8 w-32\" />\r\n          <div className=\"flex items-center gap-4\">\r\n            <Skeleton className=\"h-11 w-11 rounded-lg\" />\r\n            <Skeleton className=\"h-12 w-16\" />\r\n            <Skeleton className=\"h-11 w-11 rounded-lg\" />\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <ShareModal\r\n        isOpen={isShareModalOpen}\r\n        onClose={() => setIsShareModalOpen(false)}\r\n        requestId={requestId}\r\n        requestTitle={requestTitle}\r\n        requestSlug={requestSlug}\r\n      />\r\n\r\n      <div className=\"flex flex-wrap items-center justify-between gap-6 w-full rounded-2xl border border-foreground/10 bg-foreground/[0.03] px-8 py-6 shadow-sm\">\r\n        <div className=\"flex flex-col gap-3 max-w-xl\">\r\n          <p className=\"text-2xl font-semibold text-foreground\">\r\n            Kenal temen yang bisa bantu kasih feedback?\r\n          </p>\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            Bagikan request ini supaya mereka bisa bantu kamu.\r\n          </p>\r\n          <div className=\"flex items-center gap-4\">\r\n            <Button\r\n              onClick={() => setIsShareModalOpen(true)}\r\n              variant={\"default\"}\r\n              size=\"lg\"\r\n              className=\"h-11 px-6 text-base\"\r\n              disabled={isVoteLoading || isSaveLoading}\r\n            >\r\n              <Share size={18} className=\"mr-2\" />\r\n              Bagikan\r\n            </Button>\r\n            <Button\r\n              onClick={handleCopyLink}\r\n              variant={\"outline\"}\r\n              size=\"lg\"\r\n              className=\"h-11 w-11 p-0 relative\"\r\n              disabled={isCopyLoading || isVoteLoading || isSaveLoading}\r\n              title=\"Copy link request\"\r\n            >\r\n              {isCopyLoading ? (\r\n                <Loader2 size={20} className=\"animate-spin\" />\r\n              ) : (\r\n                <Link2 size={20} />\r\n              )}\r\n            </Button>\r\n            <Button\r\n              onClick={handleSave}\r\n              variant={isSaved ? \"default\" : \"outline\"}\r\n              size=\"lg\"\r\n              className=\"h-11 w-11 p-0 relative\"\r\n              disabled={isSaveLoading || isVoteLoading}\r\n              title={isSaved ? \"Hapus dari tersimpan\" : \"Simpan request\"}\r\n            >\r\n              {isSaveLoading ? (\r\n                <Loader2 size={20} className=\"animate-spin\" />\r\n              ) : (\r\n                <Bookmark\r\n                  size={20}\r\n                  fill={isSaved ? \"currentColor\" : \"none\"}\r\n                  className=\"transition-all duration-200\"\r\n                />\r\n              )}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex flex-col gap-3 items-center justify-center min-w-[220px]\">\r\n          <div className=\"flex flex-col items-center text-center\">\r\n            <span className=\"text-xs uppercase tracking-[0.2em] text-muted-foreground\">\r\n              Voting\r\n            </span>\r\n            <span className=\"text-base text-muted-foreground\">\r\n              Dorong feedback lebih cepat\r\n            </span>\r\n          </div>\r\n          <div className=\"flex items-center gap-4 border border-foreground/10 rounded-xl bg-background px-5 py-3\">\r\n            <Button\r\n              onClick={() => handleVote(true)}\r\n              variant={userVote === true ? \"default\" : \"ghost\"}\r\n              size=\"lg\"\r\n              className=\"h-11 w-11 p-0 relative transition-all duration-200\"\r\n              disabled={isVoteLoading || isSaveLoading || isAuthor}\r\n              title={\r\n                isAuthor\r\n                  ? \"Anda tidak dapat memvote request Anda sendiri\"\r\n                  : \"Vote up\"\r\n              }\r\n            >\r\n              {isVoteLoading && userVote === true ? (\r\n                <Loader2 size={26} className=\"animate-spin\" />\r\n              ) : (\r\n                <ChevronUp\r\n                  size={26}\r\n                  className={\r\n                    userVote === true\r\n                      ? \"text-primary-foreground\"\r\n                      : \"text-foreground\"\r\n                  }\r\n                />\r\n              )}\r\n            </Button>\r\n            <span\r\n              className={`text-3xl font-bold min-w-[3ch] text-center transition-all duration-300 ${isVoteLoading ? \"opacity-50 scale-95\" : \"opacity-100 scale-100\"\r\n                }`}\r\n            >\r\n              {currentVoteCount}\r\n            </span>\r\n            <Button\r\n              onClick={() => handleVote(false)}\r\n              variant={userVote === false ? \"default\" : \"ghost\"}\r\n              size=\"lg\"\r\n              className=\"h-11 w-11 p-0 relative transition-all duration-200\"\r\n              disabled={isVoteLoading || isSaveLoading || isAuthor}\r\n              title={\r\n                isAuthor\r\n                  ? \"Anda tidak dapat memvote request Anda sendiri\"\r\n                  : \"Vote down\"\r\n              }\r\n            >\r\n              {isVoteLoading && userVote === false ? (\r\n                <Loader2 size={26} className=\"animate-spin\" />\r\n              ) : (\r\n                <ChevronDown\r\n                  size={26}\r\n                  className={\r\n                    userVote === false\r\n                      ? \"text-primary-foreground\"\r\n                      : \"text-foreground\"\r\n                  }\r\n                />\r\n              )}\r\n            </Button>\r\n          </div>\r\n          {isVoteLoading && (\r\n            <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\r\n              <Loader2 size={12} className=\"animate-spin\" />\r\n              <span>Memproses vote...</span>\r\n            </div>\r\n          )}\r\n          {isAuthor && (\r\n            <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\r\n              <span>Anda tidak dapat memvote request Anda sendiri</span>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\Zufar\\Documents\\Projects\\RuangKoding\\components\\Profiles\\SavedFeedbackList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Zufar\\Documents\\Projects\\RuangKoding\\components\\Profiles\\YourFeedbackList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Zufar\\Documents\\Projects\\RuangKoding\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\Zufar\\Documents\\Projects\\RuangKoding\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
